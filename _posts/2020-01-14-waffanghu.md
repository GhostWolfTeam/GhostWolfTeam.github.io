---
layout: post
title:  "WAF防护原理"
categories: waf
tags: waf 原理
author: T4x0r
---



* content
{:toc}








## Web应用安全检测

Waf通常以硬件或者基于云服务器的形式提供给user的，user可以将waf透明部署在客户网站服务器的前端来抵御黑客攻击，但是呢，仅凭waf对企业网站应用经行保护是不够的，还有0day等  
我虽然仅有16岁，但是我关注这个圈子有一段时间了，我发现只要是人设计的东西都有漏洞，其实程序本身并没有漏洞，有漏洞的是人的思想  
大型企业公司组织结构通常是分布式的（根据我这个菜鸡挖洞的经验），实时监控并且快速发现包含总部，分支机构的web安全风险是非常重要的。但是基于SaaS模式的web安全检测服务可以更快的发现风险  

## SaaS模式

1.企业自建平台由web安全产品等提供的应急响应措施  
2.氪金你就是大佬  

## WAF的SQL注入绕过手段和防御技术

WAF简单说，就是解析HTTP请求，检验HTTP中参数是否存在攻击行为；若存在，则触发攻击行为。  
主要有两种主流的的方式绕过WAF，一种是利用WAF可能存在的HTTP协议解析缺陷，另一种就是利用包装后的SQL命令，使WAF无法识别SQL注入。  
一般通过HTTP协议攻击的方式，有四种绕过WAF入侵的手法：
> - 1．断包绕过  
某些早期版本的WAF不具备把TCP断包组合成完整TCP包的能力。一旦攻击者发送的HTTP请求包是断包，WAF将无法正常处理不完整的HTTP请求包。如果这些请求包中含有SQL注入语句就可以直接绕过WAF，进入web应用组成SQL注入语句。  
> - 2．缓冲区溢出  
现在的WAF产品基本都具备了对HTTP协议中参数的解析能力。但是攻击者如果故意在参数中写入过长的占位内容+shellcode，这时如果WAF产品自身对参数检验不够严格的话，则有可能导致缓冲区溢出的发生。例如改变id=1的输入为id=1 and select 0xAAAAAAAAAAA...(1000个以上)+shellcode的模式。攻击者可能会利用这种入侵手段，绕过WAF进而入侵到应用系统内部。  
> - 3．协议不兼容  
还有一种方式就是向WEB服务器发送畸形的，而非RFC2616标准的HTTP请求，这时WEB服务器可能出于兼容的目的，会尽可能解析畸形的HTTP请求，这种情况下如果WAF和WEB兼容的方式不一致则可能出现绕过现象。例如一个请求没有协议字段、没有HOST字段，默认会把HTTP协议作为0.9版本处理，HOST默认使用apache自身的servername。WAF出于兼容的目的，这时候未必能和web服务器上的server采取相同的策略。由于不同版本的HTTP有语法差异，这种情况就有可能绕过WAF进入系统内部。  
> - 4.参数污染  
参数污染简单说就是同名参数写多个，WAF往往只检查第一个参数。但服务器具体用哪个参数，策略是不相同的。
例如：xxx. php?id=0&id=7%20union%20select%201,2,3,current_user是个明显的SQL注入。WAF解析id=0 这一看就是合法的，但PHP解析得到的确是 id=7 union select .....却是个注入语句。不同的server有不同的解析方式，这个时候WAF很有可能被绕过。  

通过SQL命令包装的方式绕过WAF，是利用WAF在进行SQL命令的防御的核心技术正则匹配的缺陷。这种技术，一般通过4种匹配事变的方式进行方式：：  
> - 1．识别SQL语句的关键保留字，如select from，union select，drop table，into outfile等。  
> - 2．识别DBMS的内建函数，如version(),load_file()，sleep()，benchmark()等  
> - 3．识别DBMS内建变量，如@@version等。  
> - 4．识别数据库所识别的内联注释，如/\*!union\*/ /\*!select\*/或/\*!50000union\*/等  

## 攻击

- 1．大小写绕过  
最简单基础的一种绕过方式比如关键字SELECT早期由于正则匹配规则不健全SElect 是无法分辨出是SELECT 的导致WAF绕过，而后面的数据库则会正确解析成SELECT。  
- 2．编码绕过  
在大小写绕过的基础上开始出现编码绕过。主要有三种：URL编码、十六进制编码、Unicode编码。在浏览器中输入URL会进行一次URL编码，黑客会通过多次编码来进行WAF绕过。例如：Id.php?id=1%2520union/\*\*/select，数据库得到的Id.php?id=1 union/\*\*/select。如果只解码一次得到的是Id.php?id=1%20union/\*\*/select，就有可能绕过WAF入侵数据库。这个问题可以采用多次循环解码来处理。其中Unicode编码种类很多，如果只是基于黑名单过滤，无法处理全部情况，从而也可以实现WAF的绕过。其中UTF-32编码曾经实现过对GOOGLE的绕过。  
- 3．注释绕过  
不但可以采用编码改写关键字，还可以采用注释改写关键字，避免正则匹配。例如  
z.com/index.php?page_id=-15 %55nION/\*\*/%53ElecT 1,2,3,4'union%a0select pass from users# 。就是用符号编码代替一部分字母和判定的空格来逃避正则匹配。（selectxxx不会被拦截，因为可能是函数名等。select 空格xxx则一定会被拦截，去掉空格成为绕过的关键）。同样还有针对MYSQL版本的/\*!5000union\*/系列。  
- 4．等价替换  
等价替换是个比较大的分类，主要可以分为等价函数、等价符号、特数符号、比较符号等4类  
等价函数，就是同功能函数替换。WAF禁止了一些函数，但对另外一些函数没有禁止例如Substring()可以用mid()，substr()这些函数来替换，还可以采用生僻函数迂回完成原函数的功能，这些都可能成功实现WAF关键字绕过。and or 这种关键字在PHP中可以用|| 和&&代替，语句id=1 or 1=1就可以写成id=1 || 1=来进行绕过。同样，= 、>、<等都可以代替等号进行绕过。  
除去绕过关键字和关键符号外，最关键的是绕过空格。想各种方式避免空格出现。  
例如原句id=1 or 1=1  
可以写成：  
> id=1+or+1=1  
> id=1%0bor%0b1=1  
> id=1--s%0aor--s%0a1=1  
> id=1/\*!or\*/1=1  
> id=1()or(1=1)等多种形式进行尝试绕过  
